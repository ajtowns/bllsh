
; taproot calculation with real transaction from the blockchain

tx 02000000000101ea9eadffce2e7da9918f9c71f441c414d5c5744f68d9c2616d4d6383bf0f97200600000000fdffffff014a01000000000000225120c0f3d7b92f920a3d085ecfc5b13ab40e7cf3157abf46d527f4bb1b6e785bff06034074859af9989dc6100118829fa4d317990fab5446c8edbba422b767c8147f202fe9b6e171fc38c63f7197908d8977b23cf1af91e8f64990e2864f1ad0b238beed86204ef6bbada2a2f943c41fa3fe25a5ac3ec396ec183ab5ea9191d79202ea5e67d2ac0063036f7264010118746578742f706c61696e3b636861727365743d7574662d3800407b2270223a226272632d3230222c226f70223a227472616e73666572222c227469636b223a22f0908ab6222c22616d74223a223637383930303030303030227d6821c04ef6bbada2a2f943c41fa3fe25a5ac3ec396ec183ab5ea9191d79202ea5e67d200000000
tx_in_idx 0
tx_script 204ef6bbada2a2f943c41fa3fe25a5ac3ec396ec183ab5ea9191d79202ea5e67d2ac0063036f7264010118746578742f706c61696e3b636861727365743d7574662d3800407b2270223a226272632d3230222c226f70223a227472616e73666572222c227469636b223a22f0908ab6222c22616d74223a223637383930303030303030227d68
utxos e80700000000000022512001881c673b8245d2ccfd9ca7b99662ecadf0a09fbdc6895cb6a15fb56fe81b6d


def (VARINT2 N) (if (< N 253) (substr N 0 1) (cat 0xFD (substr (cat N 0x000000) 0 2)))
def (VARSTR S) (cat (VARINT2 (strlen S)) S)

def (TAGHASH2 SHATAG DATA) (sha256 SHATAG SHATAG DATA)
def (TAGHASH TAG DATA) (TAGHASH2 (sha256 TAG) DATA)

def (TAPLEAF V SCRIPT) (TAGHASH "TapLeaf" (cat V (VARSTR SCRIPT)))
def (TAPBRANCH A B) (TAGHASH "TapBranch" (if (<s A B) (cat A B) (cat B A)))
def (TAPPATH IPK PATH LEAF) (if PATH (TAPPATH IPK (substr PATH 32) (TAPBRANCH LEAF (substr PATH 0 32))) (TAGHASH "TapTweak" (cat IPK LEAF)))

def (TAPROOT SPKODD LEAFHASH PATH IPK SPK) (secp256k1_muladd (TAPPATH IPK PATH LEAFHASH) (rc IPK 1) (rc SPK SPKODD))

; check taproot construction for provided tx

def TAPROOTTX (TAPROOT (t (tx 9)) (tx 6) (tx 8) (tx 7) (substr (tx 16) 2))
eval (TAPROOTTX)

; manual evaluation of taproot construction

def (TAPROOTMAN V SCRIPT PATH IPK SPK) (TAPROOT (+ (& V 1)) (TAPLEAF (& V 0xFE) SCRIPT) PATH IPK SPK)
eval (TAPROOTMAN 0xc1 0x20e9d8184a170affaac4f7924a31899b1668a49d7d857b8cec611e79f39c5c7ba1ac0063036f726401010a746578742f706c61696e00337b2270223a226272632d3230222c226f70223a226d696e74222c227469636b223a22656f7262222c22616d74223a223130227d68 nil 0xe9d8184a170affaac4f7924a31899b1668a49d7d857b8cec611e79f39c5c7ba1 0xc142718fddee89867607e1eeb6e1aab685285e5c78c9ffd2f379c68d52bcb0b6)
