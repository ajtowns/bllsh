
; taproot calculation with real transaction from the blockchain

; tx e26ddff81a67b48739ca06696a6ead8e03bc7278f0fa22e5d77ebbc0612bf616
; (mainnet block 860000)

tx 02000000000103088a6b35e5031d85ff7bd04eb7d54aa1a3700023d3e337d3cf575e589f4c337b0200000000ffffffff29e934547b16ef2d7d7b46656ab4d3112cba2034711c67a57c2faf5a6da444cb0300000017160014da2cfd493b516b3d68c255c6b93d36c2c3c6f305ffffffffa2ce9bf9e93e84225d0ca5ea777d41f25dd4a676a634b4834eab1af8c6e1bb720300000017160014da2cfd493b516b3d68c255c6b93d36c2c3c6f305ffffffff052202000000000000225120f95869fa88cc2761d87adc8a5853ff79602815e6d1947aa4502fc3ffeb58e51500000000000000000d6a5d0a160000caa2338b07000015ec0c000000000017a9144a38bd047f140996300063c73ce6b2a085d96ddb87741100000000000017a9143ce20706393cdc2c8bd38867a5b5f752281215f287fc5903000000000017a914d72be0946340e917ff6f51f9635ff74ebd6a25248704406766ea4547a40bebd1a261cc0be5d8fe5f7f97e06b8d174c68de57e4edb871f3149be346679688c7c357ec1599dbe267d62e7aedcab02c31c8ee834e3ab57711401799dcb5f0b90df68a0fbf2c5fdc2559a33cf8c6206022f6cde0fc0eb7a7df2912060dbe1f69dc45801a96e348d9a3c6e90f8bd3b116fa51d1765040288b280f8720b7967296146fe0b21f0525f865f6d86100c61cebcaffa0742fff3a10d39760f4ad2069f874b81b94ac5c6d72b64b50d9f9a13d71eef2e5d57b60a13933abac16ed67ad42633866616330326261323161643064333235323965393832646136333436666238353961343731306234366335373632666335316365626630313535363166663a3061c050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac09b27d9426a144f768c02654a0bcb92a2e674ad9925e09e20836a17a91508ab8d4730da7d5516d8878a6dc515f9b7fb89130cb637a2ac46da64652c0feefa5d4d0247304402200a3f8ba40bec6409d39a99361bcd0d7d4252a2b1ef8d2407a9073243c0827626022037ce6d8960ad16b3ab5ba07be5821f495f1e996751fb5fb2c88a21672e941e8e012102b7967296146fe0b21f0525f865f6d86100c61cebcaffa0742fff3a10d39760f40248304502210090054c247b0502c777d3b9a090d68282e6ef1a5a39a8da22852de89e15d4eae402203380b8a27829278d0c50044810944ab69e5f63c92cb4e25a32b150f262eb7297012102b7967296146fe0b21f0525f865f6d86100c61cebcaffa0742fff3a10d39760f400000000
tx_in_idx 0
tx_script 20b7967296146fe0b21f0525f865f6d86100c61cebcaffa0742fff3a10d39760f4ad2069f874b81b94ac5c6d72b64b50d9f9a13d71eef2e5d57b60a13933abac16ed67ad42633866616330326261323161643064333235323965393832646136333436666238353961343731306234366335373632666335316365626630313535363166663a30
utxos 220200000000000044512055f9e2ee12cfb7b6ed5a4d6d37cd80c201f83d136597a36f870636e8183c08fb 67b908000000000017a914d72be0946340e917ff6f51f9635ff74ebd6a252487 deab070000000000445120f95869fa88cc2761d87adc8a5853ff79602815e6d1947aa4502fc3ffeb58e515

def (VARINT2 N) (if (< N 253) (substr N 0 1) (cat 0xFD (substr (cat N 0x000000) 0 2)))
def (VARSTR S) (cat (VARINT2 (strlen S)) S)

def (TAGHASH2 SHATAG DATA) (sha256 SHATAG SHATAG DATA)
def (TAGHASH TAG DATA) (TAGHASH2 (sha256 TAG) DATA)

def (TAPLEAF V SCRIPT) (TAGHASH "TapLeaf" (cat V (VARSTR SCRIPT)))
def (TAPBRANCH A B) (TAGHASH "TapBranch" (if (<s A B) (cat A B) (cat B A)))
def (TAPPATH IPK PATH LEAF) (if PATH (TAPPATH IPK (substr PATH 32) (TAPBRANCH LEAF (substr PATH 0 32))) (TAGHASH "TapTweak" (cat IPK LEAF)))

def (TAPROOT SPKODD LEAFHASH PATH IPK SPK) (secp256k1_muladd (TAPPATH IPK PATH LEAFHASH) (rc IPK 1) (rc SPK SPKODD))

; check taproot construction for provided tx

def TAPROOTTX (TAPROOT (t (tx 9)) (tx 6) (tx 8) (tx 7) (substr (tx 16) 2))
eval (TAPROOTTX)

; manual evaluation of taproot construction

def (TAPROOTMAN V SCRIPT PATH IPK SPK) (TAPROOT (+ (& V 1)) (TAPLEAF (& V 0xFE) SCRIPT) PATH IPK SPK)
eval (TAPROOTMAN 0xc0 0x20b7967296146fe0b21f0525f865f6d86100c61cebcaffa0742fff3a10d39760f4ad2069f874b81b94ac5c6d72b64b50d9f9a13d71eef2e5d57b60a13933abac16ed67ad42633866616330326261323161643064333235323965393832646136333436666238353961343731306234366335373632666335316365626630313535363166663a30 0x9b27d9426a144f768c02654a0bcb92a2e674ad9925e09e20836a17a91508ab8d4730da7d5516d8878a6dc515f9b7fb89130cb637a2ac46da64652c0feefa5d4d 0x50929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac0 0x55f9e2ee12cfb7b6ed5a4d6d37cd80c201f83d136597a36f870636e8183c08fb)
