; manual evaluation of taproot construction

def (VARSTR STR) (cat (strlen STR) STR)
def (TAGHASH2 SHATAG DATA) (sha256 SHATAG SHATAG DATA)
def (TAGHASH TAG DATA) (TAGHASH2 (sha256 TAG) DATA)

def (TAPLEAF V SCRIPT) (TAGHASH "TapLeaf" (cat V (VARSTR SCRIPT)))
def (TAPBRANCH A B) (TAGHASH "TapBranch" (if (<s A B) (cat A B) (cat B A)))
def (TAPPATH IPK PATH LEAF) (if PATH (TAPPATH IPK (substr PATH 32) (TAPBRANCH LEAF (substr PATH 0 32))) (TAGHASH "TapTweak" (cat IPK LEAF)))
def (TAPROOT V SCRIPT PATH IPK SPK) (secp256k1_muladd (TAPPATH IPK PATH (TAPLEAF (& V 0xFE) SCRIPT)) (rc IPK 1) (rc SPK (+ (& V 1))))

eval (TAPROOT 0xc1 0x20e9d8184a170affaac4f7924a31899b1668a49d7d857b8cec611e79f39c5c7ba1ac0063036f726401010a746578742f706c61696e00337b2270223a226272632d3230222c226f70223a226d696e74222c227469636b223a22656f7262222c22616d74223a223130227d68 nil 0xe9d8184a170affaac4f7924a31899b1668a49d7d857b8cec611e79f39c5c7ba1 0xc142718fddee89867607e1eeb6e1aab685285e5c78c9ffd2f379c68d52bcb0b6)





